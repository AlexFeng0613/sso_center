<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	  xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
	  layout:decorator="../../public/register">
	<head>
		<script text="text/javascript" th:src="@{/static/scripts/constant/constant.js}" src="../../../static/scripts/constant/constant.js"></script>
		<script text="text/javascript" th:src="@{/static/scripts/util/SSOUtil.js}" src="../../../static/scripts/util/SSOUtil.js"></script>
		<style>
			.progress_2{
				width:660px;
			}
		</style>
	</head>
	<body>
		<div class="container-fluid" layout:fragment="content">
			<div class="center">
				<form class="regForm" action="" method="post">
					<div class="ipone">

						<input type="hidden" th:value="${email}" name="email"/>
						<div class="ipone_box">
							<div class="ipone_box_l">手机号</div>
							<input type="text" name="phone" class="ipone_num"/>
							<input type="button" class="note" value="获取验证码"/>
						</div>
						<div class="ipone_box">
							<div class="ipone_box_l">验证码</div>
							<input type="text" name="" class="verify_code"/>
							<time class="count"></time>
						</div>
						<div class="ipone_box_next">
							<div class="ipone_next">下一步</div>
							<div class="skip">跳过</div>
						</div>
					</div>
				</form>
			</div>
			<script text="text/javascript">
				$(function(){
					$('.step_mark1').html('');
					$('.step_mark2').html('');
					$('.step_mark3').html('');

					$('.step_mark1').addClass('selected2');
					$('.step_mark2').addClass('selected2');
					$('.step_mark3').addClass('selected2');
					$('.step_mark4').addClass('selected1');

					$('.step_step1').addClass('selected2');
					$('.step_step2').addClass('selected2');
					$('.step_step3').addClass('selected2');
					$('.step_step4').addClass('selected1');

					//短信获取click函数
					$('.note').click(function(){
						$('input[name="phone"]').blur();
						var phone = $('input[name="phone"]').val();
						if(phone == null || phone == '' || !Constant.phonePattern.test(phone)) return false;

						time($(this),5,"获取验证码");
						var data = {
							'phone' : phone
						}

						//发送短信
						$.ajax({
							url : '/sms/sendSmsCode.json',
							type : 'POST',
							data : JSON.stringify(data),
							contentType: 'application/json',
							dataType : 'json',
							success : function(data){
								if(data.success){
								} else {
								}
							}
						});
					});

					//下一步click函数
					var demo = $(".regForm").Validform({
						btnSubmit:'.ipone_next',
						tiptype:3,
						showAllError:false,
						datatype:{
							"s11":Constant.phonePattern,
							"s4":/^\d{4}$/
						},
						callback : function(form){
							if(true){
								var data = {
									'phone' : $('input[name="phone"]').val(),
									'smsInputCode' : $('.verify_code').val()
								}
								$.ajax({
									url : '/sms/validateSmsCode.json',
									type : 'POST',
									data : JSON.stringify(data),
									contentType: 'application/json',
									dataType : 'json',
									success : function(data){
										if(data.success){
											//成功跳转
											window.location.href = '/page/register/5.html?email=' + $('input[name="email"]').val();
										} else {
											//否则提示错误
											if(data.message == '300001'){
												$.Showmsg('验证码不能为空');
												return false;
											} else if(data.message == '300002'){
												$.Showmsg('验证码已过期');
												return false;
											} else if(data.message == '300003'){
												$.Showmsg('验证码错误');
												return false;
											}
										}
									}
								});
							}
							return false;
						}
					});
					demo.tipmsg.w["s11"]=" "; //请输入11位手机号
					demo.tipmsg.w["s4"]=" ";//请输入4位数字的验证码
					demo.addRule([{
						ele:".ipone_num:eq(0)",
						datatype:"s11",
						nullmsg:' ',// 请输入手机号
						sucmsg:' '
					},{
						ele:".verify_code:eq(0)",
						datatype:"s4",
						nullmsg:' ',//请输入验证码
						sucmsg:' '
					}]);

					//跳过click函数
					$('.skip').click(function(){
						window.location.href = '/page/register/5.html?email='+$('input[name="email"]').val();
					});
				});
			</script>
		</div>
	</body>
</html>

